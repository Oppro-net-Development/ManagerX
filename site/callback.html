<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Logging in...</title>
</head>
<body>
    <p>Authentifizierung erfolgreich. Leite weiter...</p>

    <script>
        async function completeLogin() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');

            if (code) {
                try {
                    // Ruft deine API auf, die jetzt funktioniert
                    const response = await fetch(`http://127.0.0.1:3002/api/auth/callback?code=${code}`);
                    const data = await response.json();

                    if (data.access_token) {
                        // Wichtig: Speichern f√ºr api.js
                        localStorage.setItem('discord_token', data.access_token);
                        if (data.refresh_token) {
                            localStorage.setItem('discord_refresh_token', data.refresh_token);
                        }
                        localStorage.setItem('user_info', JSON.stringify(data.user));
                        
                        // Ab ins Dashboard
                        window.location.href = 'dashboard.html';
                    }
                } catch (error) {
                    console.error("Login fehlgeschlagen:", error);
                    document.body.innerHTML = "Fehler bei der Kommunikation mit der API.";
                }
            }
        }
        completeLogin();
    </script>
</body>
</html>